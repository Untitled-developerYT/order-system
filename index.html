<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Order System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsQR library for QR code decoding -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the custom QR scanner */
        #scanner-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #f1f5f9;
        }
        #scanner-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Animation for status updates */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <header class="text-center">
            <h1 id="main-title" class="text-3xl font-bold text-gray-900">Welcome!</h1>
            <p id="status-message" class="text-gray-500 mt-1">Scan the QR code on your table to begin.</p>
        </header>

        <!-- QR Code Scanner Section -->
        <div id="scanner-section">
            <div id="scanner-container">
                <video id="scanner-video" playsinline></video>
            </div>
             <p id="scanner-error" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            <button id="simulate-scan-btn" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 shadow-md">
                Simulate Scan (For Demo)
            </button>
        </div>

        <!-- Connection Status Section -->
        <div id="connection-status-section" class="hidden text-center p-4 rounded-lg">
            <p id="connection-status-text" class="font-semibold"></p>
        </div>

        <!-- Menu/Form Display Section -->
        <div id="display-container">
            <!-- Dynamic content (category buttons or forms) will be injected here -->
        </div>

    </div>
    <!-- Canvas for processing QR code frames, hidden from user -->
    <canvas id="qr-canvas" class="hidden"></canvas>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const mainTitle = document.getElementById('main-title');
            const statusMessage = document.getElementById('status-message');
            const scannerSection = document.getElementById('scanner-section');
            const video = document.getElementById('scanner-video');
            const canvas = document.getElementById('qr-canvas');
            const scannerError = document.getElementById('scanner-error');
            const displayContainer = document.getElementById('display-container');
            const connectionStatusSection = document.getElementById('connection-status-section');
            const connectionStatusText = document.getElementById('connection-status-text');
            const simulateScanBtn = document.getElementById('simulate-scan-btn');
            const canvasContext = canvas.getContext('2d');

            let websocket = null;
            let videoStream = null;
            let animationFrameId = null;
            let currentMenuData = null; // To store the whole menu

            // --- Mock Menu Data (simulates what a server would send) ---
            const mockMenuData = {
                title: "Table 12 Menu",
                description: "Please select a category to start your order.",
                categories: {
                    "Food": {
                        title: "Main Course Order",
                        description: "Select your meal and customize it.",
                        fields: [
                            { id: "table_number_food", label: "Table Number", type: "number", placeholder: "e.g., 12", required: true },
                            { id: "main_course", label: "Choose your Main Course:", type: "radio", options: ["Steak Frites", "Grilled Salmon", "Mushroom Risotto"], required: true },
                            { id: "cooking_preference", label: "Steak Preference:", type: "radio", options: ["Rare", "Medium-Rare", "Medium", "Well-Done"] },
                            { id: "add_ons_food", label: "Add-ons (Optional):", type: "checkbox", options: ["Garlic Bread", "Side Salad", "Extra Sauce"] },
                            { id: "special_requests_food", label: "Special Requests:", type: "textarea", placeholder: "Any allergies or special instructions?" }
                        ],
                        submitText: "Add Food to Order"
                    },
                    "Drinks": {
                        title: "Beverages",
                        description: "Quench your thirst.",
                        fields: [
                            { id: "drink_choice", label: "Choose your Drink:", type: "radio", options: ["Cola", "Lemonade", "Iced Tea", "Sparkling Water"], required: true },
                            { id: "add_ice", label: "Add Ice?", type: "checkbox", options: ["Yes, please"] },
                        ],
                        submitText: "Add Drinks to Order"
                    },
                    "Snacks": {
                        title: "Appetizers & Snacks",
                        description: "Something to start with.",
                        fields: [
                            { id: "snack_choice", label: "Choose a Snack:", type: "radio", options: ["Fries", "Onion Rings", "Spring Rolls"], required: true },
                            { id: "dipping_sauce", label: "Dipping Sauce:", type: "checkbox", options: ["Ketchup", "Mayonnaise", "Sweet Chili"] }
                        ],
                        submitText: "Add Snacks to Order"
                    }
                }
            };
            
            // --- WebSocket Logic ---
            function connectWebSocket(url) {
                // UI updates for connecting
                scannerSection.classList.add('hidden');
                connectionStatusSection.classList.remove('hidden');
                connectionStatusSection.className = 'text-center p-4 rounded-lg bg-yellow-100 text-yellow-800 fade-in';
                connectionStatusText.textContent = 'Connecting to server...';
                statusMessage.textContent = 'Establishing a secure connection.';

                try {
                    websocket = new WebSocket(url);
                    websocket.onopen = () => {
                        connectionStatusSection.className = 'text-center p-4 rounded-lg bg-green-100 text-green-800 fade-in';
                        connectionStatusText.textContent = 'Connected!';
                        statusMessage.textContent = 'Waiting for the menu...';
                    };
                    websocket.onmessage = (event) => {
                        try {
                            const menuData = JSON.parse(event.data);
                            currentMenuData = menuData; // Store the menu
                            displayCategorySelection(menuData);
                        } catch (error) {
                            displayError('Received invalid data from the server.');
                        }
                    };
                    websocket.onclose = () => {
                        connectionStatusSection.className = 'text-center p-4 rounded-lg bg-red-100 text-red-800 fade-in';
                        connectionStatusText.textContent = 'Disconnected';
                        statusMessage.textContent = 'Connection lost. Please scan again.';
                        mainTitle.textContent = "Welcome!";
                        displayContainer.innerHTML = '';
                        scannerSection.classList.remove('hidden');
                        startCustomScanner();
                    };
                    websocket.onerror = (error) => {
                        displayError('Could not connect to the server.');
                    };
                } catch (error) {
                    displayError("Invalid server address in QR code.");
                }
            }
            
            // --- UI Update Functions ---
            function displayError(message) {
                connectionStatusSection.classList.remove('hidden');
                connectionStatusSection.className = 'text-center p-4 rounded-lg bg-red-100 text-red-800 fade-in';
                connectionStatusText.textContent = message;
                scannerSection.classList.remove('hidden');
                startCustomScanner();
            }

            function displayCategorySelection(menuData) {
                displayContainer.innerHTML = ''; // Clear previous content
                mainTitle.textContent = menuData.title || "Our Menu";
                statusMessage.textContent = menuData.description || "Select a category.";

                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'space-y-4 fade-in';

                Object.keys(menuData.categories).forEach(categoryName => {
                    const button = document.createElement('button');
                    button.textContent = categoryName;
                    button.className = 'w-full bg-gray-800 text-white font-semibold py-4 px-4 rounded-lg hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700 transition-all duration-300 shadow-lg text-lg';
                    button.onclick = () => displayForm(menuData.categories[categoryName], menuData);
                    categoryContainer.appendChild(button);
                });

                displayContainer.appendChild(categoryContainer);
            }

            function displayForm(formData, menuData) {
                displayContainer.innerHTML = '';
                statusMessage.textContent = formData.description || 'Please fill out the form below.';
                
                const form = document.createElement('form');
                form.className = 'space-y-5 fade-in';
                form.id = 'order-form';
                form.noValidate = true;
                
                const formTitle = document.createElement('h2');
                formTitle.className = 'text-2xl font-semibold text-center';
                formTitle.textContent = formData.title;
                form.appendChild(formTitle);

                // Dynamically create fields
                formData.fields.forEach(field => {
                    const fieldContainer = document.createElement('div');
                    // ... (field creation logic remains the same as before)
                    const label = document.createElement('label');
                    label.htmlFor = field.id;
                    label.className = 'mb-2 font-medium text-gray-700';
                    label.textContent = field.label;
                    if (field.required) {
                        const requiredSpan = document.createElement('span');
                        requiredSpan.className = 'text-red-500 ml-1';
                        requiredSpan.textContent = '*';
                        label.appendChild(requiredSpan);
                    }
                    fieldContainer.appendChild(label);
                    if (field.type === 'radio' || field.type === 'checkbox') {
                        field.options.forEach(option => {
                            const optionContainer = document.createElement('div');
                            optionContainer.className = 'flex items-center mb-2';
                            const input = document.createElement('input');
                            input.type = field.type;
                            input.id = `${field.id}_${option.replace(/\s+/g, '')}`;
                            input.name = field.id;
                            input.value = option;
                            input.className = `h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 ${field.type === 'radio' ? 'rounded-full' : 'rounded'}`;
                            if(field.required) input.required = true;
                            const optionLabel = document.createElement('label');
                            optionLabel.htmlFor = input.id;
                            optionLabel.textContent = option;
                            optionLabel.className = 'ml-3 block text-sm text-gray-900';
                            optionContainer.appendChild(input);
                            optionContainer.appendChild(optionLabel);
                            fieldContainer.appendChild(optionContainer);
                        });
                    } else if (field.type === 'textarea') {
                        const textarea = document.createElement('textarea');
                        textarea.id = field.id;
                        textarea.name = field.id;
                        textarea.placeholder = field.placeholder || '';
                        textarea.rows = 4;
                        textarea.className = 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500';
                        if(field.required) textarea.required = true;
                        fieldContainer.appendChild(textarea);
                    } else {
                        const input = document.createElement('input');
                        input.type = field.type;
                        input.id = field.id;
                        input.name = field.id;
                        input.placeholder = field.placeholder || '';
                        input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500';
                        if(field.required) input.required = true;
                        fieldContainer.appendChild(input);
                    }
                    form.appendChild(fieldContainer);
                });

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'pt-2 space-y-3';

                const submitButton = document.createElement('button');
                submitButton.type = 'submit';
                submitButton.id = 'submit-order-btn';
                submitButton.textContent = formData.submitText || 'Submit';
                submitButton.className = 'w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300 shadow-md';
                buttonContainer.appendChild(submitButton);

                const backButton = document.createElement('button');
                backButton.type = 'button';
                backButton.textContent = 'Back to Menu';
                backButton.className = 'w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-all duration-300';
                backButton.onclick = () => displayCategorySelection(menuData);
                buttonContainer.appendChild(backButton);
                
                form.appendChild(buttonContainer);

                form.addEventListener('submit', (event) => handleFormSubmit(event, menuData));
                displayContainer.appendChild(form);
                
                validateForm();
                form.addEventListener('input', validateForm);
            }

            function handleFormSubmit(event, menuData) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const orderData = {};
                // ... (form data collection logic remains the same)
                form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (!orderData[cb.name]) orderData[cb.name] = [];
                    if (cb.checked) orderData[cb.name].push(cb.value);
                });
                for (const [key, value] of formData.entries()) {
                    if(form.querySelector(`[name="${key}"]`).type !== 'checkbox') {
                       orderData[key] = value;
                    }
                }

                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({ type: 'order', data: orderData }));
                    displayContainer.innerHTML = `
                        <div class="text-center p-8 bg-green-50 rounded-lg fade-in">
                            <h2 class="text-2xl font-bold text-green-800">Thank You!</h2>
                            <p class="text-green-700 mt-2">Your order has been sent.</p>
                            <button id="back-to-menu-after-submit" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 shadow-md">Order More</button>
                        </div>
                    `;
                    document.getElementById('back-to-menu-after-submit').onclick = () => displayCategorySelection(menuData);
                } else {
                    displayError("Could not send order. Connection lost.");
                }
            }
            
            function validateForm() {
                // ... (validation logic remains the same)
                const form = document.getElementById('order-form');
                if (!form) return;
                const submitButton = document.getElementById('submit-order-btn');
                const requiredFields = Array.from(form.querySelectorAll('[required]'));
                let isFormValid = true;
                requiredFields.forEach(field => {
                    if (field.type === 'radio') {
                        const radioGroup = form.querySelectorAll(`input[name="${field.name}"]`);
                        if (!Array.from(radioGroup).some(radio => radio.checked)) {
                            isFormValid = false;
                        }
                    } else if (field.value.trim() === '') {
                        isFormValid = false;
                    }
                });
                if (isFormValid) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    submitButton.disabled = true;
                    submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            // --- Custom QR Scanner Logic ---
            function stopCustomScanner() {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (videoStream) videoStream.getTracks().forEach(track => track.stop());
                animationFrameId = null;
                videoStream = null;
            }

            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        stopCustomScanner();
                        connectWebSocket(code.data);
                        return;
                    }
                }
                animationFrameId = requestAnimationFrame(tick);
            }

            async function startCustomScanner() {
                stopCustomScanner();
                scannerError.classList.add('hidden');
                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = videoStream;
                    video.play();
                    animationFrameId = requestAnimationFrame(tick);
                } catch (err) {
                    scannerError.textContent = "Could not access camera. Please grant permission.";
                    scannerError.classList.remove('hidden');
                }
            }
            
            // --- Demo Simulation ---
            simulateScanBtn.addEventListener('click', () => {
                stopCustomScanner();
                scannerSection.classList.add('hidden');
                connectionStatusSection.classList.remove('hidden');
                connectionStatusSection.className = 'text-center p-4 rounded-lg bg-yellow-100 text-yellow-800 fade-in';
                connectionStatusText.textContent = 'Connecting to mock server...';
                statusMessage.textContent = 'This is a demonstration.';
                setTimeout(() => {
                    connectionStatusSection.className = 'text-center p-4 rounded-lg bg-green-100 text-green-800 fade-in';
                    connectionStatusText.textContent = 'Connected!';
                    currentMenuData = mockMenuData; // Store menu for demo
                    displayCategorySelection(mockMenuData);
                }, 1000);
            });

            // Start the QR scanner when the page loads
            startCustomScanner();
        });
    </script>
</body>
</html>
